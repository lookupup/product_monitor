import time
import smtplib
from email.mime.text import MIMEText
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
import schedule

# ====== é…ç½®åŒº ======
URL = "https://www.sephora.com.au/products/glo-skin-beauty-c-shield-anti-pollution-moisture-tint/v/1n"
TARGET_PRICE = 50.00
CHECK_INTERVAL = 10  # æ£€æŸ¥é—´éš”ï¼ˆåˆ†é’Ÿï¼‰

SMTP_SERVER = 'smtp.gmail.com'
SMTP_PORT = 587
EMAIL_ADDRESS = 'ä½ çš„é‚®ç®±'
EMAIL_PASSWORD = 'ä½ çš„åº”ç”¨ä¸“ç”¨å¯†ç '
TO_EMAIL = 'æ”¶ä»¶é‚®ç®±'

def send_email(subject, body):
    msg = MIMEText(body, 'plain', 'utf-8')
    msg['Subject'] = subject
    msg['From'] = EMAIL_ADDRESS
    msg['To'] = TO_EMAIL

    with smtplib.SMTP(SMTP_SERVER, SMTP_PORT) as server:
        server.starttls()
        server.login(EMAIL_ADDRESS, EMAIL_PASSWORD)
        server.send_message(msg)
        print("ğŸ“§ é‚®ä»¶å·²å‘é€ï¼")

def check_product():
    print("ğŸ” æ­£åœ¨æ£€æŸ¥äº§å“çŠ¶æ€...")
    options = Options()
    options.add_argument('--headless')
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    driver = webdriver.Chrome(options=options)

    try:
        driver.get(URL)
        time.sleep(5)

        try:
            out_of_stock_element = driver.find_element("xpath", "//span[contains(text(), 'Out of Stock')]")
            in_stock = False
        except:
            in_stock = True

        try:
            price_element = driver.find_element("xpath", "//span[contains(@class, 'ProductPrice')]")
            price_text = price_element.text.strip().replace('$', '')
            price = float(price_text)
        except:
            price = None

        print(f"åº“å­˜çŠ¶æ€: {'æœ‰è´§' if in_stock else 'ç¼ºè´§'}")
        print(f"å½“å‰ä»·æ ¼: ${price if price else 'æœªçŸ¥'}")

        if in_stock and price and price <= TARGET_PRICE:
            subject = "ğŸ‰ Sephoraå•†å“æœ‰è´§ä¸”é™ä»·å•¦ï¼"
            body = f"ğŸ‘‰ äº§å“é“¾æ¥ï¼š{URL}\nğŸ’² å½“å‰ä»·æ ¼ï¼š${price}\nğŸ“¦ åº“å­˜çŠ¶æ€ï¼šæœ‰è´§ï¼\nèµ¶å¿«å»æŠ¢è´­ï¼"
            send_email(subject, body)
        else:
            print("â„ï¸ æ¡ä»¶æœªæ»¡è¶³ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ£€æŸ¥ã€‚")

    except Exception as e:
        print(f"å‘ç”Ÿé”™è¯¯: {e}")
    finally:
        driver.quit()

if __name__ == "__main__":
    check_product()
